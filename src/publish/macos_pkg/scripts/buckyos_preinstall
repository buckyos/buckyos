#!/bin/zsh
set -e
BUCKYOS_ROOT="${BUCKYOS_ROOT:-/opt/buckyos}"
DAEMON_PLIST="/Library/LaunchDaemons/buckyos.service.plist"
AGENT_PLIST="/Library/LaunchAgents/buckyos.service.plist"

run_with_timeout() {
  # macOS doesn't ship GNU timeout; use perl alarm for a best-effort timeout.
  # Usage: run_with_timeout 10 command args...
  local seconds="$1"
  shift
  /usr/bin/perl -e '$t=shift; alarm $t; exec @ARGV' "$seconds" "$@"
}

echo "[buckyos] preinstall: stopping service (best effort)"
# Don't use kickstart here: it may start (or wait for) the job and block in installer context.
launchctl disable "system/buckyos.service" >/dev/null 2>&1 || true
run_with_timeout 10 launchctl bootout system "$DAEMON_PLIST" >/dev/null 2>&1 || true
rm -f "$DAEMON_PLIST" >/dev/null 2>&1 || true

CONSOLE_USER="$(/usr/bin/stat -f%Su /dev/console 2>/dev/null || true)"
if [ -n "$CONSOLE_USER" ] && [ "$CONSOLE_USER" != "root" ] && [ "$CONSOLE_USER" != "loginwindow" ]; then
  CONSOLE_UID="$(/usr/bin/id -u "$CONSOLE_USER" 2>/dev/null || true)"
  if [ -n "$CONSOLE_UID" ]; then
    run_with_timeout 10 launchctl bootout "gui/$CONSOLE_UID" "$AGENT_PLIST" >/dev/null 2>&1 || true
  fi
fi
rm -f "$AGENT_PLIST" >/dev/null 2>&1 || true

echo "[buckyos] preinstall: remove module paths (keep data)"
# BEGIN AUTO-GENERATED: modules
rm -rf "$BUCKYOS_ROOT/bin/node-daemon"
rm -rf "$BUCKYOS_ROOT/bin/system-config"
rm -rf "$BUCKYOS_ROOT/bin/verify-hub"
rm -rf "$BUCKYOS_ROOT/bin/scheduler"
rm -rf "$BUCKYOS_ROOT/bin/control-panel"
rm -rf "$BUCKYOS_ROOT/bin/smb-service"
rm -rf "$BUCKYOS_ROOT/bin/repo-service"
rm -rf "$BUCKYOS_ROOT/bin/buckycli"
rm -rf "$BUCKYOS_ROOT/bin/node-active"
rm -rf "$BUCKYOS_ROOT/bin/sys-test"
rm -rf "$BUCKYOS_ROOT/bin/app-loader"
rm -rf "$BUCKYOS_ROOT/etc/scheduler"
rm -rf "$BUCKYOS_ROOT/etc/boot_gateway.yaml"
rm -rf "$BUCKYOS_ROOT/bin/util.py"
rm -rf "$BUCKYOS_ROOT/bin/stop.py"
# END AUTO-GENERATED: modules
