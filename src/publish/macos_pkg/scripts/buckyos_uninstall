#!/bin/zsh
set -e
BUCKYOS_ROOT="${BUCKYOS_ROOT:-/opt/buckyos}"
PLIST="/Library/LaunchDaemons/buckyos.service.plist"
AGENT_PLIST="/Library/LaunchAgents/buckyos.service.plist"
run_with_timeout() {
  local seconds="$1"
  shift
  /usr/bin/perl -e '$t=shift; alarm $t; exec @ARGV' "$seconds" "$@"
}
echo "[buckyos] uninstall: stopping service"
launchctl disable "system/buckyos.service" >/dev/null 2>&1 || true
run_with_timeout 10 launchctl bootout system "$PLIST" >/dev/null 2>&1 || true
rm -f "$PLIST" || true
echo "[buckyos] uninstall: removing legacy LaunchAgent (if any)"
CONSOLE_USER="$(/usr/bin/stat -f%Su /dev/console 2>/dev/null || true)"
if [ -n "$CONSOLE_USER" ] && [ "$CONSOLE_USER" != "root" ] && [ "$CONSOLE_USER" != "loginwindow" ]; then
  CONSOLE_UID="$(/usr/bin/id -u "$CONSOLE_USER" 2>/dev/null || true)"
  if [ -n "$CONSOLE_UID" ]; then
    run_with_timeout 10 launchctl bootout "gui/$CONSOLE_UID" "$AGENT_PLIST" >/dev/null 2>&1 || true
  fi
fi
rm -f "$AGENT_PLIST" || true
echo "[buckyos] uninstall: removing modules + clean_paths"
# BEGIN AUTO-GENERATED: modules
rm -rf "$BUCKYOS_ROOT/bin/node-daemon"
rm -rf "$BUCKYOS_ROOT/bin/system-config"
rm -rf "$BUCKYOS_ROOT/bin/verify-hub"
rm -rf "$BUCKYOS_ROOT/bin/scheduler"
rm -rf "$BUCKYOS_ROOT/bin/control-panel"
rm -rf "$BUCKYOS_ROOT/bin/smb-service"
rm -rf "$BUCKYOS_ROOT/bin/repo-service"
rm -rf "$BUCKYOS_ROOT/bin/buckycli"
rm -rf "$BUCKYOS_ROOT/bin/node-active"
rm -rf "$BUCKYOS_ROOT/bin/sys-test"
rm -rf "$BUCKYOS_ROOT/bin/app-loader"
rm -rf "$BUCKYOS_ROOT/etc/scheduler"
rm -rf "$BUCKYOS_ROOT/etc/boot_gateway.yaml"
rm -rf "$BUCKYOS_ROOT/bin/util.py"
rm -rf "$BUCKYOS_ROOT/bin/stop.py"
# END AUTO-GENERATED: modules
# BEGIN AUTO-GENERATED: clean_paths
rm -rf "$BUCKYOS_ROOT/cache"
rm -rf "$BUCKYOS_ROOT/logs"
rm -rf "$BUCKYOS_ROOT/tmp"
rm -rf "$BUCKYOS_ROOT/local"
rm -rf "$BUCKYOS_ROOT/etc"
# END AUTO-GENERATED: clean_paths
