# DFS Client API Design

我们为不同的语言提供CLient API (Rust Firtst,然后大概率是C)
使用Client API时，以为着当前进程是一个“富客户端”
最常见的一个“富客户端”实现，是fuse的service, 该service基于dfs的client api， 提供了标准的文件系统访问服务

## 基本概念
富客户端API会在初始化时，根据配置建立进程内cache
以root身份运行的富客户端，可以管理机器级别的缓存。（一台机器上只有一个？）
一些核心流程


### 基本的文件/对象操作
- 读取只读文件（已经对象化成功）： 读取一个内存映射文件，当缺页的（Cache Miss)会触发去Chunk Server获取的逻辑
- 读取标准文件（未对象化，可能修改）：
    该文件的copy在本机（系统只有1-2个file server node):读取一个内存映射文件，该file就是file server管理的，可以直接读到最新的文件内容
    该文件的copy不在本机，建立内存映射缓存，缺页时按标准流程去dfs的file server请求获取最新的文件内容
- 独占写入文件
- 标准写入文件

- 读取混合文件（对象化+DiffFile），相对比较复杂
    从分层的角度考虑，写入混合文件需要上层显示的计算Diff并传入
        1. append
        2. 基于文本行的diff
        3. 二进制，基于分页的difff(和btree逻辑相似)
        4. 待补充 

    根据混合模式是追加还是标准Diff决定先读diffile还是先读对象部分
    diff file是一个流式的修改记录，读取逻辑和标准file相同，但需要对读取结果做解析后才能返回
    该格式的定义会是一个关键设计
    当该文件对象化时，会将DiffFile变成DiffObject

- 写入混合文件
    写入混合文件的核心是打开Difffile,然后根

- 独占写入混合文件



### 目录操作/ObjectMap操作

- 创建目录
- list目录 （注意对超大目录的支持）
- 移动目录 （是否要和重命名区分？）
- （批量）移动文件
- 复制目录
- （批量）复制文件
- （批量） Pull文件
- 删除目录
- （批量）删除文件

- 创建文件链接
- 创建目录链接 （注意COW模式）

- 设置目录的属性（有一些属性是影响目录的）
- 挂载ObjectMap(注意模式)


### 对关键特性的原生友好
- 针对不同的目录，设置不同的操作log纪录粒度，方便快速计算改变(diff),实现更高性能的增量备份和增量同步
- 支持COW或Dir操作版本号，底层具有事务性，支持系统不停机构建文件系统快照（构建文件快照时，会等待所有文件关闭，并阻止新的打开）
- 天然支持目录/文件历史修改记录
- 非均质的存储与cache，能根据不同的目录定义上述关键行为的默认逻辑，配置正确可以提高性能/降低成本
- 冷数据对象化，对象化结构与cyfs一直，方便发布和基于objid的互相链接， 对象化减少冗余存储，释放空间 


## FILE API


## NDN API


## PATH(Dir) API

## 管理接口
