# 站在用户端看到的需求

## 构建单节点DFS的用户操作流程:

- 用户可以使用任何已有的技术来创建逻辑磁盘
- 在逻辑磁盘上建立Chunk Bucket并加入到DFS中,建立的时候需要设置Bucket Type,最大大小和保留大小。以及保留剩余空间
- 一个逻辑磁盘智能建立一个Chunk Bucket
- 在逻辑磁盘上建立MetaDB并加入到DFS中。
- DFS可用

## DFS扩容

- DFS可以在运行时增加本机的Bucket
- DFS可以在运行时增加Node:Bucket
- 当DFS加入新节点后，DFS会优先完成MetaDB的分布式化
- 等待自动的OPTask完成，DFS已目标状态正常运行
- DFS会给出当前状态的可靠性/可用性指标，以及扩容后的可靠性/可用性指标
- 应为LLM存在，我们总是可以让LLM给用户一些基于当前系统配置的，高性价比的的扩容方案建议


## 手工调整DFS的配置

99%的情况下，系统都是自动生成配置，但我们也允许高级用户手工编辑配置。配置修改后会对系统的可靠性，可用性，性能产生影响

- 修改Bucket的类型 （比如从Storage->Cache)
- 修改某些目录的缓存配置和副本配置
    - 更改写入处理链和读取处理链的逻辑？
- 修改某些目录的编码配置

## DFS的故障修复

- 节点失效: 报告节点实现，并报告对系统可用性/可靠性的影响
  - 是否导致系统进入只读状态
  - 可用性影响：哪些目录不可用（或从读写变成只读）
  - 可靠性影响：哪些数据已经丢失，哪些数据丢失的风险变高
  - 节点失效有的时候是易于修复的（比如重启一下或简单维修），有的时候则是永久损坏。我们不认为普通有具有把损坏节点里的硬盘单独拿出来的能力。 

- Bucket（磁盘）失效：
  - 可用性影响：

### 系统的可靠性状态分级由高到底：（备份状态和系统状态是同时显示的）

1. 安全:（能承受异地损坏，比如火灾）
2. 部分安全:异地损坏会丢失部分数据
3. 存在风险:单设备损坏会导致数据丢失 （丢失1日内数据的风险会被标记为低风险，不配置备份的话，系统的数据可靠性最高等级就在这里）---> 提示Enable 备份
4. 有风险：单磁盘损坏会导致数据丢失，单不会有重要数据丢失 ---> 提示增加设备或维修设备
5. 警告：单磁盘损坏会导致重要数据丢失 ---> 提示增加设备或维修设备
6. 错误：已经有数据丢失，系统正努力为未丢失数据提供服务。此时系统通常会自动进入只读状态已防止事故扩大 ---> 给出错误报告，并谨慎的给出修复方案
7. 失效：DFS已无法通过自动方法修复 ---> 修复方案是用可用设备组成新系统（容量要足够），然后从备份中回复。 未备份则需要请专业人士介入

### 系统的可用性状态分级    

1. 正常:系统能提供预期速度的读写服务，数据写入成功后再很短时间里，就能抵御任何节点失效
2. 乐观正常：系统能提供预期速度的读写服务，但数据写入成功后需要一段时间才能抵御任何节点失效
3. 写风险：系统能提供预期速度的读写服务，但数据写入成功后需要在备份完成后才能抵御任何节点失效
4. 系统异常：系统发现可自动修复的异常，在异常修复前系统进入只读状态，修复成功后系统自动恢复正常。
5. 只读：系统发生无法自动修复的异常，在用户完成修复前，系统保持只读状态。此时所有数据都是可读的
6. 错误：系统目前有严重错误，进入尽力返回数据状态，只有部分数据可读
7. 失效：系统已经无法处理任何指令

## 系统的修复提示

- 系统总是优先尝试自动修复，在修复期间可以短暂的让系统处于性能下降或不可写状态
- 用户按系统的修复操作完成操作后，也需要等待一个软件上的确认过程（这个过程可能并不断），需要在这个期间让系统的可用性尽快回到`写风险`
- 我们的终极保底方案是：确认数据已备份/重置系统/恢复数据，这个操作消耗的时长一般是可预期的

### 更换故障节点

系统只能提示故障，不会轻易的把节点判定为故。用户再进入操作之前，需要手工确认节点的故障，并进行正确的标记，以方便系统进行后续操作。在标记的状态下，节点的系统状态通常是离线。
更换节点对小系统是一个重大调整，这通常会意味着系统一定会不可用。如果在我们系统上有运行去中心的IM/社交软件，这种短时的不可用也会越来越难被接受。

先换再退减少不可用时间：

- 我们鼓励厂商采用先换再退模式进行维系：节点故障后先申请拿到新设备（可能要交押金）再邮寄回老设备。`系统有一段时间是新、老设备同时运行`，完成了必要的运维操作后提示用户关闭老设备。不可用的时间很短

鼓励扩大系统规模：

- 当系统有3个或以上节点，并有足够容量时，就有机会能想典型的商业分布式系统一样，能容量任何的节点不可用。我们鼓励有条件的用户从这个状态开始使用DFS
- 此时节点故障后（或则立刻不可用后），用户也可以再

构建临时节点（或混合存储）方案：（性能换可用）

- 基本思路是临时修改系统配置，让系统保持一个最小范围的可用。比如通过删除已备份的老数据，来腾出空间，让系统可以写入数据。这种配置下，在缓存未命中时性能会很差。

### 更换故障磁盘

- 站在通用系统的角度考虑，我们会给出系统里需要替换的硬盘提示，这个提示可以忽略
- 会给出新替换硬盘要求的最小容量
- 即使系统处在正常状态，也可以允许有故障磁盘，有经验的用户可以累计一段时间后再一口气替换
- 系统可以设置自动停用有故障硬盘（这对保护机械硬盘有一定的效果），已停用的硬盘只响应紧急读操作


## 删除（故障）磁盘/节点

当系统的规模很大时，可以在不影响系统的可用性和可靠性的情况下，删除已有的节点/磁盘。

## DFS的数据备份和恢复

- 数据备份首先会建立快照，随后等待外部的备份软件完成备份，该快照被标记为已备份
- 有些快照需要依赖另一个快照，可以看到快照之间的依赖关系
- 可以手工建立一个全量快照。此快照不依赖之前的快照，备份该快照基本相当于备份全部数据
- 快照在备份的时候系统处于 “可用，数据备份中”的状态
- DFS可以选择从任意一个可用的快照恢复。恢复时系统处于 “不可用，数据恢复中”的状态。

## 手工维护友好

- bucket在保存在磁盘上的普通目录里，可以很容易看出来其由原数据和chunk块组成
- 支持标准目录操作来手工备份/恢复一个bucket

