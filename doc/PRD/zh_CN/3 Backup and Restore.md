# 备份配置与故障恢复

摘要：数据的可靠性是BuckyOS最关注的特性，也是用户使用Personal Server里需要解决的第一个核心问题。本章讲述了BuckyOS系统提供的备份和恢复功能


## 一、备份与恢复的基本概念

BuckyOS安装在一个Personal Cluster上，Cluster的基础特性让BuckyOS有了一定的数据可靠性。其主要提现在`系统里任意一块硬盘的损坏，都不会丢失数据`。但由于Personal Cluster的规模较小，我们没有足够的冗余来实现"系统里任意一个设备损坏，都不丢失数据"，当家里遭遇火灾、水灾等灾难时，数据的丢失是不可避免的。因此，BuckyOS系统提供了备份和恢复功能，以在这种情况下保护用户的数据安全。

从成本和性能的角度进行Trade Off, BuckyOS系统的备份系统是异步的，其基本运行逻辑类似iCloud:在系统相对空闲的时候尽力备份，备份任务的优先级通常不高。通常的配置是“每天备份”，这意味着如果用户的设备意外损坏，用户最多会丢失一天的数据。当系统超过1天没有备份时且有足够多的新用户数据时，系统会发出警告，提醒用户尽快进行备份。


### 待备份数据

系统基本按目录执行备份任务，在没有特殊的配置下，特定目录内的所有数据会被备份。

系统默认按下面的顺序进行备份,除了/bsys/data的备份优先级无法调整外，我们允许管理员调整其它目录的备份优先级。（UI上允许将某个app的优先级设置为20）

- /bsys/data 该部分数据可以看做是buckyOS的boot分区，其大小不会超过备份服务器的最大扇区容量。优先级为50
- 优先级为20的Appdata
- dfs://library/photos 备份用户自己拍摄的照片和短片，优先级为19
- dfs://homes 备份所有用户的个人数据 优先级为 17
- dfs://library/public 备份公开文档 优先级为 15
- dfs://library/share 备份用户之间共享的文档 优先级为 13
- 优先级为10的Appdata
- dfs://system 优先级为 9，system本身并没有特别重要的非结构化数据，其非结构化数据一般是缓存性质的，因此优先级不高。
- dfs://media 优先级为 5
- dfs://appdata, app本身可以声明自己的备份优先级组，我们有5个组。 -20，-10，0，10，20， 优先级默认为0，最高为20
- dfs://appcache  优先级为 -25

当优先级>=0的任务完成后，一次备份任务就已经完成。在此任务基础上，会继续推进优先级<0的任务，直到所有任务完成。
系统按优先级默认有5个备份配置组，可以针对不同的配置组设置不同的备份可靠性，默认的配置组为

- 大于等于20 , 关键数据 备份3份
- [10,20) 用户显示创建的重要数据 备份3份
- [0,10) 用户隐式创建的数据，备份2份
- [-10,0) 用户的收藏数据，备份2份
- [-50,-10) 尽力而为的加速数据，备份1份
- -50 以下的数据不用备份

### CheckPoint

备份开始时，会创建一个Backup CheckPoint.通常一个备份任务需要执行较长的时间，因此我们尽量选择系统空闲时进行备份。

### 备份扇区与基本备份流程

'Zero Trust'是BuckyOS的基本原则，因此我们使用密码学的方法来确保备份数据的隐私安全。通过引入备份扇区来统一备份服务器的接口。备份扇区一般是固定大小的文件，最小为2G，4G,8G,... 64G. 
让我们来看一下备份的基本流程：

1. 备份任务启动，
2. 基于CheckPoint打包数据(可以理解成一个tar的过程)，如果本次备份依赖上一次成功的备份，那么可以只打包增量数据。打包好的结果里要包含足够的元数据。
3. 打包数据要按最少扇区数原则切分成原始扇区，如果打包的数据是34G，那么应该用一个32G的扇区和一个2G的扇区来保存。可以用原始扇区的Hash来唯一的表达一个原始扇区。原始扇区使用主流格式，方便用户自行查看里面的内容。
4. 根据备份任务的配置向Backup Target请求指定份数的备份扇区。随后为每个备份扇区生成一个AES密钥，用该密钥加密备份扇区的数据，然后备份任务Owner的公钥加密AES密钥并将加密后的AES秘钥保存到扇区的原数据区，得到一个加密后的备份扇区。
5. 一个原始扇区可以产生多个备份扇区（多个副本），并在/bsys/data中保存 `checkpoint->原始扇区->备份扇区` 的映射关系。
6. 向Backup Target发备份扇区后，删除本地的备份扇区。
7. 在dfs://system 目录下保存原始扇区的`部分存根数据`后，可以删除原始扇区 （一般会保存至少1个checkpoint的原始扇区用来做增量备份的base 计算）
8. 在保存了 /bsys/data 数据的备份服务器上进行一些元数据设置，可以方便查询“最新的/bsys/data”的备份扇区id


上述流程中，只要用户妥善保存了自己的私钥(秘钥可以是自动根据用户秘钥对生成，也可以是根据用户手工输入的密码生成），就不会让备份服务器看到原始扇区的内容。通过将不同的备份扇区保存在不同的Backup Target上，可以进一步提高备份数据的可靠性。
上述备份流程是离线的，如果用户的新数据很少，长期使用最小的2G备份扇区会有一定的浪费，此时用户可以延迟备份的间隔，或则有一些Backup Target，提供了动态备份扇区的功能，允许用户实时的更新扇区。
构建一个BuckyOS的备份服务器并不复杂，只需支持一些简单的通用接口，就可以成为一个BuckyOS的Backup Target，我们期待未来会有很多的BuckyOS Backup Target提供商，不管是基于传统云计算的，还是基于去中心infra的，BuckyOS的备份框架保障了用户选择的权力。


### 不停机恢复

不停机恢复是指在BuckyOS没有停机的情况下，进行数据恢复。

在大部分方式，BuckyOS都以透明的方式进行数据恢复。比如OOD的一块硬盘损坏，系统会给出强力的警告，告诉用户尽快完成修复。用户根据引导联系经销商，获得新的OOD（过保修的设备可以直接买新的），随后激活新的OOD，新的OOD此时会进入恢复模式，等数据恢复完成后，新的OOD进入正常模式，旧的OOD进入待机模式。用户可将旧的OOD寄回给经销商。如果不需要寄回旧的OOD，可以对待机的旧OOD进行配置

1. 屏蔽损坏的硬盘，并初始化为新设备
2. 更换新的硬盘，并初始化为新设备

该设备在翻新后加入Zone后，Zone内拥有两个有效的OOD,DFS的有效空间会增加。
对高级用户来说，也可以手工替换损坏的硬盘，此时该硬盘的数据会自动恢复。

不停机恢复依靠的是BuckyOS的内部机制实现(system_config和DFS内置的数据修复机制)，不需要访问Backup Target服务器。

### 停机恢复

停机恢复是指在BuckyOS已经停机的情况下，进行数据恢复。

恢复的另一种常见场景是OOD完全损坏了（无法开机），此时系统必然进入了只读状态，用户需要尽快购买新的OOD，然后作为旧OOD的替代设备激活。在激活后，系统会提示用户进行系统恢复，当系统恢复完成后，系统会恢复正常可用的状态。


### 手动恢复

用户还可以手工触发恢复（高级功能，会导致部分数据丢失）。选择一个Backup时的Checkup,点击恢复，系统就会停机恢复到备份时的状态。
手动恢复属于停机恢复，在恢复过程中，系统会停止工作。

### 通过Backup Target恢复的一般流程

停机恢复和手动恢复都需要访问Backup Target，其基本流程如下：

1. 通过ZoneConfig得到Backup Target信息
2. 向Backup Target查询包含了/bsys/data的最新的备份扇区id （手工恢复可以跳过第1，2步的查询）
3. 向Backup Target请求包含了最新/bsys/data的备份扇区id
4. 基于私钥解密备份扇区的AES密钥，解密备份扇区的数据，得到原始扇区
5. 通过原始扇区重建/bsys/data
6. 启动系统(system_config服务和DFS服务启动），并让系统进入恢复模式
7. 在恢复模式下读取system_config中的记录，得到重建所有数据的扇区列表
8. 按备份扇区的优先级，依次请求BACKUP TARGET的备份扇区，并在dfs://上重建数据
9. 恢复完成，系统进入正常模式
10. 通知用户恢复完成, 并在一定时间后删除下载的备份扇区


## 二、Bakcup Manage UI （TODO：需要图片）


### 备份提示

1. 在系统首次激活时，有入口配置备份，但为了让用户尽快用起来，该设置并非是强制的。
2. 触发要求配置（干预）备份的时机：

- 计算发现集群的可靠性过低时（集群的可靠性计算是另一个一个严肃的需求，需要详细的文档化），最常见的一个场景是一块硬盘已经损坏
- 集群有足够的容量，或运行了足够长的时间时。
- 集群很久没有完成备份，或待备份数据持续增长

### 启用首个BACKUP TARGET

基于Zero Trust原则，BuckyOS里内置的Backup Target是DMCX（基于去中心网络的Backup Target），该Backup Target的工作不依赖任何公司。
商用的OOD产品，通常已经对Backup Target进行了配置，用户只需激活订阅即可。我们也会根据生态发展情况，内置一些适应不同国家地区的订阅服源给用户订阅。
用户也可以自己添加兼容BuckyOS协议的Backup Target。Backup Target本质上一个URL，用户可以通过扫描二维码或输入URL的方式添加Backup Target。
用户还可以通过安装dApp的方法来添加新的Backup Target。我们会推动基于主流网盘的Backup Target。



### 配置备份任务

如上所述，系统已经有了默认的备份任务配置，用户可以通过该界面调整备份任务的绑定的Backup Target、不同Backup Target里的副本数量、和优先级、跳过条件。


### 执行备份任务


根据未备份数据、系统配置、备份优先级的情况创建备份任务（含多个子任务）
以任务为粒度进行数据的准备
准备完成后开始进行准备备份扇区，并开始写入。一个备份扇区可以包含多个任务的数据。但一个子任务的数据应尽量在一个扇区中。
标记备份子任务完成

数据准备会消耗一定的临时磁盘空间，针对上述备份任务系统应尽可能寻找更
单个的备份扇区，备份子任务应该有足够的元信息，以便于在有合适工具的前提下，尽可能的读取其中包含的内容。



### 查看备份任务


目前正在执行的备份任务信息：
正在执行的备份任务的预期完成时间、总大小、占用的临时空间大小
按子任务：任务简介，当前状态，处理速度

查看历史已经完成的备份任务：

备份任务配置：（每项任务中应计算其相关数据的大小）
有一些备份任务是必选的。可以设置备份的频次。如果系统本身的可靠性不够高，会在备份频次上进行默认提示。
配置需要备份的系统数据（目录），设置优先级
配置需要备份的应用，设置优先级
配置备份任务的附加Backup Target（默认使用默认Backup Target，默认Backup Target可以是多个）
上一次备份成功数据，已完成备份数据的总大小，已备份数据的扇区信息，未备份数据的总大小，


### 检查Backup Target的状态

当通过检查Backup Target得知某个备份扇区失效后，会启动一个特殊的备份任务，来恢复备份扇区。该任务的优先级较高。
基本流程是：

1. 先尝试得到备份扇区的原始扇区（如果本地还有这一步就可以跳过）
2. 基于原始扇区会在构造一个新的备份扇区，以保证备份扇区的副本数达到要求

## 四、管理Backup Target的订阅

对于一个稳定运行的系统来说，用户对备份系统的关注点就是2个

1. 数据的可靠性：没有备份的数据有多少，还有多久才能完成备份？是不是备份系统的性能不行
2. Backup Target的订阅是需要消耗成本的，按现在的消耗速度，还有多久需要续费？

对Backup Target的订阅管理，主要就是站在财务的角度帮助用户管理好系统的备份成本。



## 五、几种恢复方式的UI 

### 停机恢复

### 手工恢复

### 不停机恢复

不停机恢复一般是隐式的，但可以在Taskbar上看到一个恢复的进度条，点击可以查看详细的恢复进度。


## 六、通过自己自足实现永久备份

1. 安装DMC Miner应用
2. 给DMC Miner分配空间，并配置挖矿参数，开始挖矿
3. 只要挖矿收入能覆盖DMCBackup Target的消耗，就可以实现永久备份
4. 系统会计算实现永久备份需要分配多少空间给DMC Miner


## 七、用户数据备份

前述备份机制是站在Zone管理员的视角看到的备份逻辑，围绕这一个Zone的数据的备份和恢复来。但BuckyOS是一个多用户系统，用户也可以自定义自己的备份逻辑。用户自定义的备份逻辑的本质流程是“用户数据的导出”。基于用户数据备份的，用户可以在ZoneA上导出自己的数据，并在ZoneB上导入自己的数据，如果ZoneB上用户的权限大于等于ZOneA上的权限，那么用户基本实现Zone的迁移。


## 八、与备份扇区有关的必要辅助工具



